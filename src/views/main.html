<!DOCTYPE html>
<html>

<head>
    <title>Linux Network Monitor</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="monitor.js"></script> <!-- Include the new monitoring script -->
    <style>
        .disappeared {
            color: red; /* Style for disappeared connections */
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
    </style>
</head>

<body>
    <h2>Connected IPs:</h2>
    <select id="process-dropdown" onchange="monitorProcess(this.value)">
        <option value="">Select a process</option>
        <!-- Options will be populated here -->
    </select>
    
    <!-- Show a table for each connection with an IP:port pair -->
    <table id="connection-list">
        <thead>
            <tr>
                <th>IP Address</th>
                <th>Port</th>
                <th>Total Packets</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td colspan="3">No connections</td>
            </tr>
        </tbody>
    </table>

    <script>
        // Variable to store process data
        let processListData = [];

        // Function to update the process list from lsof
        function updateProcessList() {
            exec('sudo lsof -nP -i', (error, stdout, stderr) => {
                if (error) {
                    console.error("Error:", error.message);
                    return;
                }
                if (stderr) {
                    console.warn("Warnings:", stderr);
                }

                // Clear previous output before displaying new output
                const lines = stdout.trim().split('\n');
                const uniqueProcesses = new Set();
                const dropdown = document.getElementById('process-dropdown');

                // Clear existing options
                dropdown.innerHTML = '<option value="">Select a process</option>';

                // Create dropdown options
                for (let i = 1; i < lines.length; i++) {
                    const columns = lines[i].split(/\s+/);
                    if (columns.length >= 9) { // Ensure there are enough columns
                        const command = columns[0];
                        const pid = columns[1];
                        const user = columns[2];

                        // Add unique processes to the Set
                        const processKey = `${command}-${pid}-${user}`;
                        if (!uniqueProcesses.has(processKey)) {
                            uniqueProcesses.add(processKey);
                            processListData.push({ command, pid, user }); // Store data in variable

                            // Create an option for the dropdown
                            const option = document.createElement('option');
                            option.value = pid; // Use PID as the value
                            option.textContent = `${command} (PID: ${pid})`; // Display command and PID
                            dropdown.appendChild(option); // Append option to dropdown
                        }
                    }
                }
            });
        }

        // Initial call to populate the process list
        updateProcessList();
    </script>
</body>

</html>
